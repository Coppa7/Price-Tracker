<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset = "UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>Amazon Price Tracker</title>
</head>
<body>
    <main>
        <div class = "webpage_title"><h1>Amazon Price Tracker</h1></div>
        <div class = "url_query_bar_div">
            <form action = "/query" method = "POST" id = "url_query_bar">
                <input type = "text" id = "url_query" name = "url_query" placeholder="Paste an Amazon URL..." required><br>
                <button type = "submit">Search</button>
            </form>
        </div>
        {% if bookmarks %}
            {%for bookmark in bookmarks %}
                <div class = "bookmark">
                    {% if bookmark.img_src != "N/A" %}
                        <img src = "{{ bookmark.img_src }}" class = "bookmark_image" alt = "bookmark_product_image">
                    {% endif %}
                    <!-- Price should always exist if the page has loaded correctly -->
                    <p class = "bookmark_name">{{bookmark.name}}</p>
                    <p class = "bookmark_price">{{bookmark.price}}</p>
                    <p class = "bookmark_discount">{{bookmark.discount}}</p>
                    <p class = "bookmark_ASIN">{{bookmark.ASIN}}</p>
                    <button class = "button unbook_button" onclick = "unbook_function('{{bookmark.ASIN}}')">Unbook</button><br><br>
            {% endfor %}
            </div>
        {% endif %}
        <script>
            function unbook_function(ASIN_json)
            {
                Swal.fire({ //Pop up for unbooking
                    title: "Are you sure?",
                    text: "Are you sure you want to delete this product from your bookmarks?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Yes, I want to remove it",
                    cancelButtonText: "No, I don't want to remove it"
                })
                .then(response => {
                    if(response.isConfirmed){ //If user decides to unbook
                        fetch("/unbook", {
                            method: "POST",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify(ASIN_json)
                        })
                        .then(result => {
                            if(result.ok){
                                return Swal.fire({
                                    title: "Removed",
                                    text: "Product has been removed from your bookmarks",
                                    icon: "success",
                                    timer: 1500,
                                    showConfirmButton: false
                                })
                                .then(() => {
                                    window.location.reload();
                                });
                            }
                            else {
                                Swal.fire("Error", "Bookmark couldn't be removed, try again", "error");
                            }
                        })
                        .catch(error => {
                            console.error("Network error:", error);
                            Swal.fire("Error", "Communication error", "error");
                        });
                    }
                })
            }
        </script>
    </main>
</body>
</html>